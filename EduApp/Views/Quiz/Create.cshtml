@using EduApp.ViewModels
@model QuizDto

<h2>Create Quiz</h2>

<form asp-action="Create" method="post" id="quizForm">
    @Html.AntiForgeryToken()
    @await Html.PartialAsync("_CreateEditForm", Model)
</form>

@section Scripts {
    <script>
        let questionIndex = 0;

        // Create a question card with 2 default answers
        function createQuestionCard(index) {
            const card = document.createElement('div');
            card.classList.add('question-card', 'border', 'p-3', 'mb-3');
            card.dataset.index = index;

            function createAnswerItem(answerIndex) {
                return `
                    <div class="answer-item mb-1 d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-danger me-2 remove-answer">×</button>
                        <input type="hidden" name="Questions[0].Answers[0].IsCorrect" value="false"/>
                        <input type="checkbox" name="Questions[${index}].Answers[${answerIndex}].IsCorrect" value="true"/>
                        <input name="Questions[${index}].Answers[${answerIndex}].Text" class="form-control" placeholder="Answer ${answerIndex + 1}" />
                    </div>
                `;
            }

            card.innerHTML = `
                <h5>Question ${index+1}</h5>
                <input name="Questions[${index}].Text" class="form-control mb-2" placeholder="Enter question text" />

                <div class="answers-block">
                    ${[0,1].map(j => createAnswerItem(j)).join('')}
                </div>

                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-primary prev-question">Previous</button>
                    <button type="button" class="btn btn-sm btn-primary next-question">Next</button>
                    <button type="button" class="btn btn-sm btn-secondary add-answer">Add Answer</button>
                    <button type="button" class="btn btn-sm btn-danger delete-question">Delete Question</button>
                </div>
            `;

            return card;
        }

        const container = document.getElementById('questionsContainer');
        const addBtn = document.getElementById('addQuestionBtn');

        // Add a new question
        addBtn.addEventListener('click', () => {
            container.appendChild(createQuestionCard(questionIndex));
            showQuestion(questionIndex);
            questionIndex++;
        });

        // Show only one question at a time
        function showQuestion(index) {
            const cards = document.querySelectorAll('.question-card');
            cards.forEach((c,i) => c.style.display = i === index ? 'block' : 'none');

            // Disable prev/next buttons on first/last question
            cards.forEach((c,i) => {
                const nextBtn = c.querySelector('.next-question');
                const prevBtn = c.querySelector('.prev-question');
                if(nextBtn) nextBtn.disabled = i === cards.length - 1;
                if(prevBtn) prevBtn.disabled = i === 0;
            });
        }

        // Handle clicks inside question container
        container.addEventListener('click', e => {
            const card = e.target.closest('.question-card');
            if(!card) return;
            let index = parseInt(card.dataset.index);

            // Navigation
            if(e.target.classList.contains('next-question')) showQuestion(index + 1);
            if(e.target.classList.contains('prev-question')) showQuestion(index - 1);

            // Add answer
            if (e.target.classList.contains('add-answer')) {
                const answersBlock = card.querySelector('.answers-block');
                const answerCount = answersBlock.querySelectorAll('.answer-item').length;
                const div = document.createElement('div');
                div.classList.add('answer-item', 'mb-1', 'd-flex', 'align-items-center');
                div.innerHTML = `
                    <button type="button" class="btn btn-sm btn-danger me-2 remove-answer">×</button>
                    <input type="hidden" name="Questions[0].Answers[0].IsCorrect" value="false" />
                    <input type="checkbox" name="Questions[${index}].Answers[${answerCount}].IsCorrect" value="true" />
                    <input name="Questions[${index}].Answers[${answerCount}].Text" class="form-control" placeholder="Answer ${answerCount + 1}" />
                `;
                answersBlock.appendChild(div);
            }

            // Remove answer
            if(e.target.classList.contains('remove-answer')) {
                e.target.closest('.answer-item').remove();
                // Reindex answers
                const answers = card.querySelectorAll('.answer-item');
                      answers.forEach((a,j) => {
                const textInput = a.querySelector('input[type="text"]');
                const checkboxInput = a.querySelector('input[type="checkbox"]');
                textInput.name = `Questions[${index}].Answers[${j}].Text`;
                checkboxInput.name = `Questions[${index}].Answers[${j}].IsCorrect`;
            });
            }

            // Delete question
            if(e.target.classList.contains('delete-question')) {
                card.remove();
                const cards = document.querySelectorAll('.question-card');
                cards.forEach((c,i) => {
                    c.dataset.index = i;
                    c.querySelector('h5').textContent = `Question ${i+1}`;
                    c.querySelector('input[name^="Questions"]').name = `Questions[${i}].Text`;
                    c.querySelectorAll('.answer-item input[type="text"]').forEach((a,j) => {
                        a.name = `Questions[${i}].Answers[${j}].Text`;
                    });
                    c.querySelectorAll('.answer-item input[type="checkbox"]').forEach((r,j) => {
                        r.name = `Questions[${i}].Answers[${j}].IsCorrect`;
                        r.value = j;
                    });
                });
                questionIndex = cards.length;
                showQuestion(Math.min(index, cards.length-1));
            }
        });

        // Show first question initially (if any)
        showQuestion(0);
    </script>
}
