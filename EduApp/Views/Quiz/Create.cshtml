@using EduApp.ViewModels
@model QuizDto

<h2>Create Quiz</h2>

<form asp-action="Create" method="post" id="quizForm">
    <div class="form-group mb-3">
        <label>Title</label>
        <input asp-for="Title" class="form-control" />
    </div>

    <div class="form-group mb-3">
        <label>Description</label>
        <textarea asp-for="Description" class="form-control"></textarea>
    </div>

    <h3>Questions</h3>
    <div id="questionsContainer"></div>

    <button type="button" class="btn btn-secondary mb-3" id="addQuestionBtn">Add Question</button>
    <br />
    <button type="submit" class="btn btn-success">Save Quiz</button>
</form>

@section Scripts {
    <script>
        let questionIndex = 0;

        // Create a question card with 2 default answers
        function createQuestionCard(index) {
            const card = document.createElement('div');
            card.classList.add('question-card', 'border', 'p-3', 'mb-3');
            card.dataset.index = index;

            card.innerHTML = `
                <h5>Question ${index+1}</h5>
                <input name="Questions[${index}].Text" class="form-control mb-2" placeholder="Enter question text" />

        <div class="answers-block">
            ${[0,1].map(j => `
                <div class="answer-item mb-1 d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-danger me-2 remove-answer">×</button>
                    <input name="Questions[${index}].Answers[${j}].Text" class="form-control" placeholder="Answer ${j+1}" />
                </div>
            `).join('')}
        </div>

                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-primary prev-question">Previous</button>
                    <button type="button" class="btn btn-sm btn-primary next-question">Next</button>
                    <button type="button" class="btn btn-sm btn-secondary add-answer">Add Answer</button>
                    <button type="button" class="btn btn-sm btn-danger delete-question">Delete Question</button>
                </div>
            `;

            return card;
        }

        const container = document.getElementById('questionsContainer');
        const addBtn = document.getElementById('addQuestionBtn');

        // Add initial question if desired (optional)
        // container.appendChild(createQuestionCard(questionIndex));
        // showQuestion(0);

        addBtn.addEventListener('click', () => {
            container.appendChild(createQuestionCard(questionIndex));
            showQuestion(questionIndex);
            questionIndex++;
        });

        // Show one question at a time
        function showQuestion(index) {
            const cards = document.querySelectorAll('.question-card');
            cards.forEach((c,i) => c.style.display = i === index ? 'block' : 'none');

            // Hide next button on last question
            cards.forEach((c,i) => {
                const nextBtn = c.querySelector('.next-question');
                if(nextBtn) nextBtn.disabled = i === cards.length - 1;
            });

            // Disable previous button on first question
            cards.forEach((c,i) => {
                const prevBtn = c.querySelector('.prev-question');
                if(prevBtn) prevBtn.disabled = i === 0;
            });
        }

        container.addEventListener('click', e => {
            const card = e.target.closest('.question-card');
            if(!card) return;
            let index = parseInt(card.dataset.index);

            // Next / Previous navigation
            if(e.target.classList.contains('next-question')) showQuestion(index + 1);
            if(e.target.classList.contains('prev-question')) showQuestion(index - 1);

            // Add answer
            if (e.target.classList.contains('add-answer')) {
                const answersBlock = card.querySelector('.answers-block');
                const answerCount = answersBlock.querySelectorAll('.answer-item').length;
                const div = document.createElement('div');
                div.classList.add('answer-item', 'mb-1', 'd-flex', 'align-items-center'); // flex layout
                div.innerHTML = `
                    <button type="button" class="btn btn-sm btn-danger me-2 remove-answer">×</button>
                    <input name="Questions[${index}].Answers[${answerCount}].Text" class="form-control" placeholder="Answer ${answerCount + 1}" />
                `;
                answersBlock.appendChild(div);
            }

            // Remove answer
            if(e.target.classList.contains('remove-answer')) {
                e.target.closest('.answer-item').remove();
                // Reindex answers
                const answers = card.querySelectorAll('.answer-item');
                answers.forEach((a,j) => {
                    const input = a.querySelector('input');
                    input.name = `Questions[${index}].Answers[${j}].Text`;
                });
            }

            // Delete question
            if(e.target.classList.contains('delete-question')) {
                card.remove();
                // Reindex remaining questions
                const cards = document.querySelectorAll('.question-card');
                cards.forEach((c,i) => {
                    c.dataset.index = i;
                    c.querySelector('h5').textContent = `Question ${i+1}`;
                    c.querySelector('input[name^="Questions"]').name = `Questions[${i}].Text`;
                    c.querySelectorAll('.answer-item input').forEach((a,j) => {
                        a.name = `Questions[${i}].Answers[${j}].Text`;
                    });
                });
                questionIndex = cards.length;
                showQuestion(Math.min(index, cards.length-1));
            }
        });

        // Initially show first question if any
        showQuestion(0);

    </script>
}
